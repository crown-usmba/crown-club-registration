// بيانات الترجمة
const translations = {
    ar: {
        "club-name": "نادي CROWN",
        "club-description": "للأنشطة الاقتصادية والاجتماعية والإنسانية والرياضية",
        "follow-us": "تابعنا على الإنستغرام",
        "personal-info": "المعلومات الشخصية",
        "first-name": "الاسم الأول",
        "first-name-error": "يرجى إدخال الاسم الأول",
        "last-name": "الاسم الأخير",
        "last-name-error": "يرجى إدخال الاسم الأخير",
        "cin": "رقم بطاقة التعريف الوطنية (CIN)",
        "cin-error": "يرجى إدخال رقم بطاقة التعريف الوطنية",
        "massar": "رقم مسار",
        "massar-error": "يرجى إدخال رقم مسار صحيح",
        "email": "البريد الإلكتروني الجامعي",
        "email-error": "يرجى إدخال بريد إلكتروني جامعي صحيح",
        "phone": "رقم الهاتف",
        "phone-error": "يرجى إدخال رقم هاتف صحيح",
        "major": "التخصص",
        "major-error": "يرجى إدخال تخصصك",
        "year": "سنة الدراسة",
        "select-year": "اختر السنة",
        "first-year": "سنة أولى",
        "second-year": "سنة ثانية",
        "third-year": "سنة ثالثة",
        "fourth-year": "سنة رابعة",
        "graduate": "دراسات عليا",
        "year-error": "يرجى اختيار سنة الدراسة",
        "interests": "اهتمامات النادي",
        "activities-label": "اختر مجالات الأنشطة التي تهمك",
        "economic-activities": "الأنشطة الاقتصادية",
        "social-activities": "الأنشطة الاجتماعية",
        "human-activities": "الأنشطة الإنسانية",
        "sport-activities": "الأنشطة الرياضية",
        "activities-error": "يرجى اختيار مجال نشاط واحد على الأقل",
        "sport-options-title": "اختر الرياضة التي تفضل",
        "volleyball": "الكرة الطائرة",
        "basketball": "كرة السلة",
        "sport-error": "يرجى اختيار رياضة واحدة",
        "interest": "ما الذي يثير اهتمامك في نادينا؟",
        "interest-error": "يرجى إخبارنا بما يثير اهتمامك في نادينا",
        "experience": "الخبرة السابقة (إن وجدت)",
        "additional-info": "معلومات إضافية",
        "availability": "متى تكون متاحاً عادةً للاجتماعات؟",
        "weekday-mornings": "صباح أيام الأسبوع",
        "weekday-afternoons": "بعد ظهر أيام الأسبوع",
        "weekday-evenings": "مساء أيام الأسبوع",
        "weekends": "عطلات نهاية الأسبوع",
        "availability-error": "يرجى اختيار مدى توافرك",
        "hear-about": "كيف سمعت عنا؟",
        "select-option": "اختر خياراً",
        "friend": "صديق",
        "professor": "أستاذ",
        "social-media": "وسائل التواصل الاجتماعي",
        "poster": "ملصق/نشرة",
        "university-website": "موقع الجامعة",
        "club-fair": "معرض الأندية",
        "other": "آخر",
        "mailing-list": "أرغب في تلقي تحديثات النادي عبر البريد الإلكتروني",
        "whatsapp-updates": "أرغب في تلقي تحديثات النادي عبر واتساب",
        "agree": "أوافق على شروط وأحكام النادي",
        "agree-error": "يجب الموافقة على الشروط والأحكام",
        "submit": "إكمال التسجيل",
        "success-title": "مرحباً في عائلة CROWN!",
        "success-message": "تم استلام طلبك بنجاح وسنتواصل معك قريباً للترحيب بك رسمياً في النادي",
        "error-title": "خطأ في الإرسال",
        "error-message": "حدث خطأ أثناء إرسال البيانات. يرجى المحاولة مرة أخرى.",
        "next": "التالي",
        "prev": "السابق"
    },
    fr: {
        "club-name": "Club CROWN",
        "club-description": "Pour les activités économiques, sociales, humanitaires et sportives",
        "follow-us": "Suivez-nous sur Instagram",
        "personal-info": "Informations personnelles",
        "first-name": "Prénom",
        "first-name-error": "Veuillez saisir votre prénom",
        "last-name": "Nom",
        "last-name-error": "Veuillez saisir votre nom",
        "cin": "Numéro de carte d'identité nationale (CIN)",
        "cin-error": "Veuillez saisir votre numéro CIN",
        "massar": "Numéro Massar",
        "massar-error": "Veuillez saisir un numéro Massar valide",
        "email": "E-mail universitaire",
        "email-error": "Veuillez saisir une adresse e-mail universitaire valide",
        "phone": "Numéro de téléphone",
        "phone-error": "Veuillez saisir un numéro de téléphone valide",
        "major": "Spécialité",
        "major-error": "Veuillez saisir votre spécialité",
        "year": "Année d'étude",
        "select-year": "Choisir l'année",
        "first-year": "Première année",
        "second-year": "Deuxième année",
        "third-year": "Troisième année",
        "fourth-year": "Quatrième année",
        "graduate": "Études supérieures",
        "year-error": "Veuillez choisir votre année d'étude",
        "interests": "Intérêts du club",
        "activities-label": "Choisissez les domaines d'activité qui vous intéressent",
        "economic-activities": "Activités économiques",
        "social-activities": "Activités sociales",
        "human-activities": "Activités humanitaires",
        "sport-activities": "Activités sportives",
        "activities-error": "Veuillez choisir au moins un domaine d'activité",
        "sport-options-title": "Choisissez votre sport préféré",
        "volleyball": "Volley-ball",
        "basketball": "Basket-ball",
        "sport-error": "Veuillez choisir un sport",
        "interest": "Qu'est-ce qui vous intéresse dans notre club?",
        "interest-error": "Veuillez nous dire ce qui vous intéresse dans notre club",
        "experience": "Expérience préalable (le cas échéant)",
        "additional-info": "Informations supplémentaires",
        "availability": "Quand êtes-vous généralement disponible pour les réunions?",
        "weekday-mornings": "Matin en semaine",
        "weekday-afternoons": "Après-midi en semaine",
        "weekday-evenings": "Soir en semaine",
        "weekends": "Week-ends",
        "availability-error": "Veuillez choisir votre disponibilité",
        "hear-about": "Comment avez-vous entendu parler de nous?",
        "select-option": "Choisir une option",
        "friend": "Ami",
        "professor": "Professeur",
        "social-media": "Réseaux sociaux",
        "poster": "Affiche/ brochure",
        "university-website": "Site web de l'université",
        "club-fair": "Forum des clubs",
        "other": "Autre",
        "mailing-list": "Je souhaite recevoir les mises à jour du club par e-mail",
        "whatsapp-updates": "Je souhaite recevoir les mises à jour du club par WhatsApp",
        "agree": "J'accepte les termes et conditions du club",
        "agree-error": "Vous devez accepter les termes et conditions",
        "submit": "Soumettre l'inscription",
        "success-title": "Bienvenue dans la famille CROWN!",
        "success-message": "Votre demande a été reçue avec succès et nous vous contacterons bientôt pour vous accueillir officiellement dans le club",
        "error-title": "Erreur d'envoi",
        "error-message": "Une erreur s'est produite lors de l'envoi des données. Veuillez réessayer.",
        "next": "Suivant",
        "prev": "Précédent"
    },
    en: {
        "club-name": "CROWN Club",
        "club-description": "For economic, social, humanitarian and sports activities",
        "follow-us": "Follow us on Instagram",
        "personal-info": "Personal Information",
        "first-name": "First Name",
        "first-name-error": "Please enter your first name",
        "last-name": "Last Name",
        "last-name-error": "Please enter your last name",
        "cin": "National ID Card Number (CIN)",
        "cin-error": "Please enter your CIN number",
        "massar": "Massar Number",
        "massar-error": "Please enter a valid Massar number",
        "email": "University Email",
        "email-error": "Please enter a valid university email",
        "phone": "Phone Number",
        "phone-error": "Please enter a valid phone number",
        "major": "Major",
        "major-error": "Please enter your major",
        "year": "Study Year",
        "select-year": "Select Year",
        "first-year": "First Year",
        "second-year": "Second Year",
        "third-year": "Third Year",
        "fourth-year": "Fourth Year",
        "graduate": "Graduate Studies",
        "year-error": "Please select your study year",
        "interests": "Club Interests",
        "activities-label": "Choose activity areas that interest you",
        "economic-activities": "Economic Activities",
        "social-activities": "Social Activities",
        "human-activities": "Humanitarian Activities",
        "sport-activities": "Sports Activities",
        "activities-error": "Please choose at least one activity area",
        "sport-options-title": "Choose your preferred sport",
        "volleyball": "Volleyball",
        "basketball": "Basketball",
        "sport-error": "Please choose a sport",
        "interest": "What interests you about our club?",
        "interest-error": "Please tell us what interests you about our club",
        "experience": "Previous Experience (if any)",
        "additional-info": "Additional Information",
        "availability": "When are you usually available for meetings?",
        "weekday-mornings": "Weekday Mornings",
        "weekday-afternoons": "Weekday Afternoons",
        "weekday-evenings": "Weekday Evenings",
        "weekends": "Weekends",
        "availability-error": "Please choose your availability",
        "hear-about": "How did you hear about us?",
        "select-option": "Select an option",
        "friend": "Friend",
        "professor": "Professor",
        "social-media": "Social Media",
        "poster": "Poster/Flyer",
        "university-website": "University Website",
        "club-fair": "Club Fair",
        "other": "Other",
        "mailing-list": "I want to receive club updates via email",
        "whatsapp-updates": "I want to receive club updates via WhatsApp",
        "agree": "I agree to the club's terms and conditions",
        "agree-error": "You must agree to the terms and conditions",
        "submit": "Complete Registration",
        "success-title": "Welcome to the CROWN Family!",
        "success-message": "Your application has been received successfully and we will contact you soon to officially welcome you to the club",
        "error-title": "Submission Error",
        "error-message": "An error occurred while sending data. Please try again.",
        "next": "Next",
        "prev": "Previous"
    }
};

// Main Application
class CrownClubForm {
    constructor() {
        this.currentStep = 1;
        this.totalSteps = 3;
        this.currentLang = 'ar';
        this.formData = {};
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setupLanguageSwitcher();
        this.updateProgressBar();
        this.animateStats();
    }

    setupEventListeners() {
        // Step navigation
        document.addEventListener('click', (e) => {
            if (e.target.closest('.btn-next')) {
                const nextStep = parseInt(e.target.closest('.btn-next').dataset.next);
                this.nextStep(nextStep);
            }
            
            if (e.target.closest('.btn-prev')) {
                const prevStep = parseInt(e.target.closest('.btn-prev').dataset.prev);
                this.prevStep(prevStep);
            }
        });

        // Interest cards
        document.querySelectorAll('.interest-card').forEach(card => {
            card.addEventListener('click', (e) => {
                this.toggleInterestCard(card);
            });
        });

        // Sport buttons
        document.querySelectorAll('.sport-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.selectSportButton(btn);
            });
        });

        // Availability cards
        document.querySelectorAll('.availability-card').forEach(card => {
            card.addEventListener('click', (e) => {
                this.toggleAvailabilityCard(card);
            });
        });

        // Preference cards
        document.querySelectorAll('.preference-card').forEach(card => {
            card.addEventListener('click', (e) => {
                this.togglePreferenceCard(card);
            });
        });

        // Agreement card
        document.querySelector('.agreement-card').addEventListener('click', (e) => {
            this.toggleAgreementCard();
        });

        // Form submission
        document.getElementById('registrationForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.submitForm();
        });

        // Success modal close
        document.getElementById('closeSuccess').addEventListener('click', () => {
            this.closeSuccessModal();
        });

        // Input focus effects
        document.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('focus', () => {
                input.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', () => {
                input.parentElement.classList.remove('focused');
            });
        });
    }

    setupLanguageSwitcher() {
        const langButtons = document.querySelectorAll('.lang-btn');
        
        langButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const lang = btn.dataset.lang;
                if (lang) {
                    this.switchLanguage(lang);
                }
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            document.querySelector('.lang-dropdown').style.display = 'none';
        });

        // Initialize language
        this.switchLanguage(this.currentLang);
    }

    switchLanguage(lang) {
        this.currentLang = lang;
        
        // Update HTML direction and language
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        document.documentElement.lang = lang;
        
        // Update all translatable elements
        this.updateTranslations();
        
        // Update active language button
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.lang === lang) {
                btn.classList.add('active');
            }
        });
    }

    updateTranslations() {
        const elements = document.querySelectorAll('[data-translate]');
        
        elements.forEach(element => {
            const key = element.getAttribute('data-translate');
            if (translations[this.currentLang] && translations[this.currentLang][key]) {
                if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                    element.placeholder = translations[this.currentLang][key];
                } else if (element.tagName === 'OPTION' && element.value === '') {
                    element.textContent = translations[this.currentLang][key];
                } else {
                    element.textContent = translations[this.currentLang][key];
                }
            }
        });

        // Update button texts
        document.querySelectorAll('.btn-next span').forEach(span => {
            span.textContent = translations[this.currentLang]['next'];
        });
        
        document.querySelectorAll('.btn-prev span').forEach(span => {
            span.textContent = translations[this.currentLang]['prev'];
        });
    }

    nextStep(nextStep) {
        if (this.validateStep(this.currentStep)) {
            this.currentStep = nextStep;
            this.showStep(this.currentStep);
            this.updateProgressBar();
        }
    }

    prevStep(prevStep) {
        this.currentStep = prevStep;
        this.showStep(this.currentStep);
        this.updateProgressBar();
    }

    showStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.remove('active');
        });
        
        // Show current step
        const currentStep = document.getElementById(`step${stepNumber}`);
        if (currentStep) {
            currentStep.classList.add('active');
        }
        
        // Update progress steps
        document.querySelectorAll('.step').forEach((step, index) => {
            if (index + 1 <= stepNumber) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
    }

    updateProgressBar() {
        const progress = (this.currentStep / this.totalSteps) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
    }

    validateStep(step) {
        let isValid = true;
        
        // Clear previous errors
        document.querySelectorAll('.error-message').forEach(error => {
            error.textContent = '';
        });

        switch(step) {
            case 1:
                // Validate personal information
                const requiredFields = ['firstName', 'lastName', 'cin', 'massar', 'email', 'phone', 'major', 'year'];
                
                requiredFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (!element || !element.value.trim()) {
                        const errorElement = document.getElementById(`${field}Error`);
                        if (errorElement) {
                            errorElement.textContent = translations[this.currentLang][`${field.replace(/([A-Z])/g, '-$1').toLowerCase()}-error`];
                        }
                        isValid = false;
                    }
                });
                break;

            case 2:
                // Validate interests
                const selectedInterests = document.querySelectorAll('input[name="interests"]:checked');
                if (selectedInterests.length === 0) {
                    document.getElementById('activitiesError').textContent = translations[this.currentLang]['activities-error'];
                    isValid = false;
                }

                // Validate sport if sport interest is selected
                const sportInterest = document.querySelector('input[value="sport"]:checked');
                if (sportInterest) {
                    const selectedSport = document.querySelector('input[name="sport"]:checked');
                    if (!selectedSport) {
                        document.getElementById('sportError').textContent = translations[this.currentLang]['sport-error'];
                        isValid = false;
                    }
                }

                // Validate interest text
                const interestText = document.getElementById('interest');
                if (!interestText || !interestText.value.trim()) {
                    document.getElementById('interestError').textContent = translations[this.currentLang]['interest-error'];
                    isValid = false;
                }
                break;

            case 3:
                // Validate availability
                const selectedAvailability = document.querySelectorAll('input[name="availability"]:checked');
                if (selectedAvailability.length === 0) {
                    document.getElementById('availabilityError').textContent = translations[this.currentLang]['availability-error'];
                    isValid = false;
                }

                // Validate agreement
                const agreement = document.getElementById('agree');
                if (!agreement || !agreement.checked) {
                    document.getElementById('agreeError').textContent = translations[this.currentLang]['agree-error'];
                    isValid = false;
                }
                break;
        }

        return isValid;
    }

    toggleInterestCard(card) {
        const checkbox = card.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }

        // Show/hide sport options
        if (checkbox.value === 'sport') {
            const sportOptions = document.getElementById('sportOptions');
            sportOptions.style.display = checkbox.checked ? 'block' : 'none';
        }
    }

    selectSportButton(button) {
        const radio = button.querySelector('input[type="radio"]');
        radio.checked = true;
        
        // Update visual state
        document.querySelectorAll('.sport-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        button.classList.add('selected');
    }

    toggleAvailabilityCard(card) {
        const checkbox = card.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    }

    togglePreferenceCard(card) {
        const checkbox = card.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    }

    toggleAgreementCard() {
        const checkbox = document.getElementById('agree');
        checkbox.checked = !checkbox.checked;
        
        const card = document.querySelector('.agreement-card');
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    }

    async submitForm() {
        if (this.validateStep(3)) {
            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.innerHTML = this.currentLang === 'ar' ? 
                '<span>جاري الإرسال...</span><i class="fas fa-spinner fa-spin"></i>' :
                this.currentLang === 'fr' ?
                '<span>Envoi en cours...</span><i class="fas fa-spinner fa-spin"></i>' :
                '<span>Sending...</span><i class="fas fa-spinner fa-spin"></i>';
            
            submitBtn.disabled = true;

            try {
                // Collect form data
                const formData = new FormData(document.getElementById('registrationForm'));
                
                // Send to Formspree
                const response = await fetch('https://formspree.io/f/xwpwdpze', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    this.showSuccessModal();
                    document.getElementById('registrationForm').reset();
                    this.resetFormState();
                } else {
                    throw new Error('Form submission failed');
                }
            } catch (error) {
                this.showErrorModal();
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
    }

    resetFormState() {
        // Reset to first step
        this.currentStep = 1;
        this.showStep(1);
        this.updateProgressBar();
        
        // Reset all visual states
        document.querySelectorAll('.interest-card, .sport-btn, .availability-card, .preference-card, .agreement-card').forEach(element => {
            element.classList.remove('selected');
        });
        
        document.getElementById('sportOptions').style.display = 'none';
    }

    showSuccessModal() {
        const modal = document.getElementById('successModal');
        const title = document.getElementById('successTitle');
        const message = document.getElementById('successMessage');
        
        title.textContent = translations[this.currentLang]['success-title'];
        message.textContent = translations[this.currentLang]['success-message'];
        
        modal.style.display = 'flex';
        
        // Add confetti animation
        this.createConfetti();
    }

    showErrorModal() {
        const modal = document.getElementById('successModal');
        const title = document.getElementById('successTitle');
        const message = document.getElementById('successMessage');
        
        title.textContent = translations[this.currentLang]['error-title'];
        message.textContent = translations[this.currentLang]['error-message'];
        
        modal.style.display = 'flex';
    }

    closeSuccessModal() {
        document.getElementById('successModal').style.display = 'none';
    }

    createConfetti() {
        const confettiContainer = document.querySelector('.confetti');
        confettiContainer.innerHTML = '';
        
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti-piece';
            confetti.style.cssText = `
                left: ${Math.random() * 100}%;
                animation-delay: ${Math.random() * 3}s;
                background: hsl(${Math.random() * 360}, 100%, 50%);
                transform: rotate(${Math.random() * 360}deg);
            `;
            confettiContainer.appendChild(confetti);
        }
    }

    animateStats() {
        const stats = {
            membersCount: 150,
            eventsCount: 25,
            projectsCount: 12
        };

        Object.keys(stats).forEach(stat => {
            const element = document.getElementById(stat);
            if (element) {
                this.animateCounter(element, 0, stats[stat], 2000);
            }
        });
    }

    animateCounter(element, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            const value = Math.floor(progress * (end - start) + start);
            element.textContent = value + '+';
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new CrownClubForm();
});

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    .form-step {
        transition: all 0.5s ease-in-out;
    }
    
    .form-step.active {
        animation: slideIn 0.5s ease-in-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    .interest-card.selected,
    .sport-btn.selected,
    .availability-card.selected,
    .preference-card.selected,
    .agreement-card.selected {
        transform: scale(1.05);
        box-shadow: 0 10px 30px rgba(212, 175, 55, 0.3);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }
    
    .fa-spinner {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .confetti-piece {
        position: absolute;
        width: 10px;
        height: 10px;
        animation: fall 3s linear forwards;
    }
    
    @keyframes fall {
        0% {
            transform: translateY(-100px) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(500px) rotate(360deg);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
